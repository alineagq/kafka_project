---
# JMX Exporter configuration for Kafka metrics
# This configuration exports Kafka JMX metrics to Prometheus format

# Connection settings
hostPort: localhost:9101
ssl: false

# Lowercasing
lowercaseOutputName: true
lowercaseOutputLabelNames: true

# Whitelist of ObjectNames to query
whitelistObjectNames:
  - "kafka.controller:*"
  - "kafka.server:*"
  - "kafka.network:*"
  - "kafka.log:*"
  - "kafka.cluster:*"
  - "kafka.coordinator:*"
  - "java.lang:*"

# Rules to extract and transform metrics
rules:
  # Kafka Server metrics
  - pattern: kafka.server<type=(.+), name=(.+), clientId=(.+), topic=(.+), partition=(.*)><>Value
    name: kafka_server_$1_$2
    type: GAUGE
    labels:
      clientId: "$3"
      topic: "$4"
      partition: "$5"

  - pattern: kafka.server<type=(.+), name=(.+), clientId=(.+), brokerHost=(.+), brokerPort=(.+)><>Value
    name: kafka_server_$1_$2
    type: GAUGE
    labels:
      clientId: "$3"
      broker: "$4:$5"

  - pattern: kafka.server<type=(.+), name=(.+), topic=(.+), partition=(.*)><>Value
    name: kafka_server_$1_$2
    type: GAUGE
    labels:
      topic: "$3"
      partition: "$4"

  - pattern: kafka.server<type=(.+), name=(.+)><>Value
    name: kafka_server_$1_$2
    type: GAUGE

  # Kafka Network metrics
  - pattern: kafka.network<type=(.+), name=(.+), request=(.+)><>Value
    name: kafka_network_$1_$2
    type: GAUGE
    labels:
      request: "$3"

  - pattern: kafka.network<type=(.+), name=(.+)><>Value
    name: kafka_network_$1_$2
    type: GAUGE

  # Kafka Controller metrics
  - pattern: kafka.controller<type=(.+), name=(.+)><>Value
    name: kafka_controller_$1_$2
    type: GAUGE

  # Kafka Log metrics
  - pattern: kafka.log<type=(.+), name=(.+), topic=(.+), partition=(.*)><>Value
    name: kafka_log_$1_$2
    type: GAUGE
    labels:
      topic: "$3"
      partition: "$4"

  - pattern: kafka.log<type=(.+), name=(.+)><>Value
    name: kafka_log_$1_$2
    type: GAUGE

  # Kafka Cluster metrics
  - pattern: kafka.cluster<type=(.+), name=(.+), topic=(.+), partition=(.*)><>Value
    name: kafka_cluster_$1_$2
    type: GAUGE
    labels:
      topic: "$3"
      partition: "$4"

  # JVM Metrics
  - pattern: 'java.lang<type=Memory><HeapMemoryUsage>(.+)'
    name: jvm_memory_heap_$1
    type: GAUGE

  - pattern: 'java.lang<type=Memory><NonHeapMemoryUsage>(.+)'
    name: jvm_memory_nonheap_$1
    type: GAUGE

  - pattern: 'java.lang<type=GarbageCollector, name=(.+)><>CollectionCount'
    name: jvm_gc_collection_count
    type: COUNTER
    labels:
      gc: "$1"

  - pattern: 'java.lang<type=GarbageCollector, name=(.+)><>CollectionTime'
    name: jvm_gc_collection_time_ms
    type: COUNTER
    labels:
      gc: "$1"

  - pattern: 'java.lang<type=Threading><>ThreadCount'
    name: jvm_threads_current
    type: GAUGE

  - pattern: 'java.lang<type=Threading><>DaemonThreadCount'
    name: jvm_threads_daemon
    type: GAUGE

  # Generic catch-all for other metrics
  - pattern: kafka.(\w+)<type=(.+), name=(.+)><>Value
    name: kafka_$1_$2_$3
    type: GAUGE
